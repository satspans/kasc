<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty – Student DB Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#0f1111;
  --panel:#161b1b;
  --panel-soft:#232f3e;
  --border:#2e3b4e;
  --text:#ffffff;
  --muted:#b0b7bd;
  --accent:#f6ff00;
  --danger:#ff0000;
  --radius:12px;
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:"Segoe UI",Arial,sans-serif;
}

body{
  background:var(--bg);
  color:var(--text);
  display:grid;
  grid-template-columns:240px 1fr;
  min-height:100vh;
}

.sidebar{
  background:#131921;
  padding:28px 20px;
  border-right:1px solid var(--border);
}

.brand{
  font-size:22px;
  font-weight:800;
  color:var(--accent);
  margin-bottom:40px;
}

.nav a{
  display:block;
  padding:14px 18px;
  border-radius:8px;
  color:var(--muted);
  text-decoration:none;
}

.nav a.active,
.nav a:hover{
  background:var(--panel-soft);
  color:#fff;
}

.header{
  position:sticky;
  top:0;
  background:#0f1111;
  border-bottom:1px solid var(--border);
  padding:24px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.header h1{font-size:30px}

.content{padding:40px}

.action-btn{
  background:var(--accent);
  border:none;
  color:#111;
  padding:10px 18px;
  border-radius:6px;
  font-weight:700;
  cursor:pointer;
}

.action-btn.danger{
  background:var(--danger);
  color:#fff;
}

select{
  width:100%;
  padding:12px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  color:#fff;
  margin-bottom:14px;
}

.table-row{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  display:grid;
  grid-template-columns:1fr 1fr auto;
  margin-bottom:10px;
}

.status-btn{
  padding:6px 14px;
  border-radius:6px;
  border:none;
  font-weight:700;
  cursor:pointer;
}

.present{background:#00ff88;color:#111}
.absent{background:#ff4d4d;color:#fff}

@media(max-width:900px){
  body{grid-template-columns:1fr}
  .sidebar{display:none}
}
</style>
</head>

<body>

<aside class="sidebar">
  <div class="brand">FACULTY•CORE</div>
  <nav class="nav">
    <a class="active" href="faculty.html">Student Attendance</a>
    <a href="student-db.html">Student DB Management</a>
    <a href="student-dashboard.html">Student Dashboard</a>
  </nav>
</aside>

<div class="main">
  <div class="header">
    <h1>Student Attendance</h1>
    <button class="action-btn danger">Logout</button>
  </div>

  <div class="content">

    <button class="action-btn" onclick="toggleAttendance()">+ Create New Attendance</button>

    <form id="attendanceForm" style="display:none;margin-top:20px;">
      <select id="dept" required>
        <option value="">Select Department</option>
        <option>Department of Computer Science (SF)</option>
        <option>Department of Tamil (SF)</option>
      </select>

      <select id="cls" required>
        <option value="">Select Class</option>
        <option>UG I Year</option>
        <option>UG II Year</option>
        <option>UG III Year</option>
        <option>PG I Year</option>
        <option>PG II Year</option>
      </select>

      <select id="sec" required>
        <option value="">Select Section</option>
        <option>Main</option>
        <option>Additional</option>
      </select>

      <button class="action-btn" type="submit">Load Students</button>
    </form>

    <div id="studentList" style="margin-top:30px;"></div>

    <button id="saveBtn" class="action-btn" style="display:none;margin-top:20px;" onclick="saveAttendance()">
      Save Attendance
    </button>

    <!-- Parents SMS Notification -->
    <button id="smsBtn" class="action-btn" style="display:none;margin-top:20px;" onclick="sendParentSMS()">
      Parents SMS Notification
    </button>

    <div id="smsLinks" style="margin-top:20px;"></div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
const supabaseclient = supabase.createClient(
  "https://wljlkyfxlgnhkltdltng.supabase.co",
  "sb_publishable_i0HnA_T0MaU3M5z_qN_Grg_YaGpDgvf"
);

const facultyEmailFromSession = sessionStorage.getItem('Email') || '';
let attendanceData = [];
var FacultyEmail = facultyEmailFromSession;

function toggleAttendance(){
  const form = document.getElementById("attendanceForm");
  form.style.display = 'block';
}

document.getElementById("attendanceForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const department = dept.value;
  const clsVal = cls.value;
  const section = sec.value;

  const { data, error } = await supabaseclient
    .from("StudentDB")
    .select("*")
    .eq("Department", department)
    .eq("Class", clsVal)
    .eq("Section", section);

  if(error || data.length === 0){
    alert("No students found");
    return;
  }

  // Attach FacultyEmail and default status Present
  attendanceData = data.map(s => ({...s, status:"Present", FacultyEmail:FacultyEmail}));
  renderStudents();
});

function renderStudents(){
  const container = document.getElementById("studentList");
  container.innerHTML = "";

  attendanceData.forEach((s,i)=>{
    container.innerHTML += `
      <div class="table-row">
        <div>${s.Rollno} - ${s.Name}</div>
        <div>${s.status}</div>
        <button class="status-btn ${s.status==="Present"?"present":"absent"}"
          onclick="toggleStatus(${i})">
          ${s.status}
        </button>
      </div>
    `;
  });

  document.getElementById("saveBtn").style.display="inline-block";
}

function toggleStatus(i){
  attendanceData[i].status =
    attendanceData[i].status === "Present" ? "Absent" : "Present";
  renderStudents();
}

async function saveAttendance(){

  const records = attendanceData.map(s=>({
    FacultyEmail:s.FacultyEmail,
    Rollno:s.Rollno,
    Attendance:s.status
  }));

  const { error } = await supabaseclient.from("AttendanceDB").insert(records);

  if(error){
    alert("Error saving attendance");
  }else{
    alert("Attendance saved successfully");
    document.getElementById("smsBtn").style.display="inline-block";
  }
}

// Send SMS to parents for absentees
async function sendParentSMS() {
    const smsContainer = document.getElementById("smsLinks");
    smsContainer.innerHTML = "";

    // Filter absentees from attendanceData
    const absentees = attendanceData.filter(s => s.status === "Absent");

    if (absentees.length === 0) {
        smsContainer.innerHTML = "<p>No absent students.</p>";
        return;
    }

    // Fetch parents' phone numbers from Supabase
    const { data: parentsData, error } = await supabaseclient
        .from("StudentDB")
        .select("ParentsPhNo")
        .in("Rollno", absentees.map(s => s.Rollno)); // get only absentees

    if (error || !parentsData || parentsData.length === 0) {
        alert("Failed to fetch parents' phone numbers.");
        return;
    }

    // Collect phone numbers into a single comma-separated string
    const parentNumbers = parentsData.map(p => p.ParentsPhNo).join(",");

    // Get faculty info (assuming stored in sessionStorage)
    const Faculty_Name = sessionStorage.getItem("FacultyName");
    const Faculty_Department = sessionStorage.getItem("FacultyDepartment");

    // Generate single SMS message
    const message = `
Dear Parent,
This is to inform you that your child was absent for today’s class.
    - ${Faculty_Name}, 
    ${Faculty_Department}, 
    Kongunadu Arts and Science College,GN Mills,Cbe-29`;

    // Create a single clickable SMS link
    const smsLink = document.createElement("a");
    smsLink.href = `sms:${parentNumbers}?body=${encodeURIComponent(message)}`;
    smsLink.textContent = "Send SMS to all absent students' parents";
    smsLink.style.display = "block";
    smsLink.style.marginBottom = "10px";

    smsContainer.appendChild(smsLink);
}


</script>

</body>
</html>
